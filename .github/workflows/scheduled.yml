name: Scheduled Build

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  scheduled-build:
    name: Weekly Build ${{ matrix.target }}
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-linux-ohos
          - aarch64-linux-ohos
          - arm-linux-ohos
          - riscv64-linux-ohos

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential gcc g++ make \
            flex bison texinfo \
            libgmp-dev libmpfr-dev libmpc-dev libisl-dev \
            zlib1g-dev libzstd-dev \
            wget curl tar xz-utils file python3 \
            autoconf automake libtool pkg-config

      - name: Build toolchain
        run: |
          chmod +x build.sh
          ./build.sh --target=${{ matrix.target }} --jobs=$(nproc) all

      - name: Verify toolchain
        run: |
          export PATH="${PWD}/install/bin:${PATH}"
          ${{ matrix.target }}-gcc --version
          echo 'int main() { return 0; }' | ${{ matrix.target }}-gcc -x c -c - -o /dev/null

      - name: Report status
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "✓ Build for ${{ matrix.target }} succeeded"
          else
            echo "✗ Build for ${{ matrix.target }} failed"
          fi
