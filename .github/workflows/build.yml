name: Build GCC Cross-Compiler for OpenHarmony

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      target:
        description: 'Target triplet (e.g., x86_64-linux-ohos)'
        required: false
        default: 'x86_64-linux-ohos'
      build_native:
        description: 'Build native OHOS compiler (Canadian Cross)'
        required: false
        default: 'true'
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'

env:
  # NDK download URL - update this when new versions are released
  NDK_URL: 'https://cidownload.openharmony.cn/version/Daily_Version/LLVM-19/20260114_061434/version-Daily_Version-LLVM-19-20260114_061434-LLVM-19.tar.gz'
  GCC_VERSION: '15.2.0'
  BINUTILS_VERSION: '2.43'
  # Enable verbose output for debugging
  DEBUG_BUILD: ${{ github.event.inputs.debug == 'true' && '1' || '' }}

jobs:
  # Stage 1: Build cross-compiler (runs on Linux, compiles for OHOS)
  build-cross:
    name: Stage 1 - Cross Compiler ${{ matrix.target }}
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-linux-ohos
          - aarch64-linux-ohos
        include:
          - target: x86_64-linux-ohos
            arch: x86_64
          - target: aarch64-linux-ohos
            arch: aarch64

    outputs:
      x86_64-success: ${{ steps.verify.outputs.x86_64-success }}
      aarch64-success: ${{ steps.verify.outputs.aarch64-success }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h
          
          # Remove unnecessary large packages
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          
          echo "=== Disk space after cleanup ==="
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc g++ \
            make \
            flex bison \
            texinfo \
            libgmp-dev \
            libmpfr-dev \
            libmpc-dev \
            libisl-dev \
            zlib1g-dev \
            libzstd-dev \
            wget curl \
            tar xz-utils \
            file \
            python3 \
            autoconf automake libtool \
            pkg-config

      - name: Display build environment info
        run: |
          echo "=== Build Environment ==="
          echo "--- System info ---"
          uname -a
          cat /etc/os-release
          
          echo "--- Compiler versions ---"
          gcc --version | head -1
          g++ --version | head -1
          
          echo "--- Available compilers ---"
          which gcc g++ x86_64-linux-gnu-gcc x86_64-linux-gnu-g++ 2>/dev/null || true
          ls -la /usr/bin/*gcc* /usr/bin/*g++* 2>/dev/null || true
          
          echo "--- Memory info ---"
          free -h
          
          echo "--- CPU info ---"
          nproc
          lscpu | grep -E 'Model name|CPU\(s\)|Thread'
          
          echo "--- Disk space ---"
          df -h

      - name: Cache NDK sysroot
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: ndk/sysroot
          key: ndk-sysroot-${{ matrix.target }}-${{ hashFiles('sysroot-patches/*.patch') }}
          restore-keys: |
            ndk-sysroot-${{ matrix.target }}-

      - name: Cache binutils build
        id: cache-binutils
        uses: actions/cache@v4
        with:
          path: |
            install/bin/${{ matrix.target }}-*
            install/${{ matrix.target }}
            install/lib/bfd-plugins
          key: binutils-${{ matrix.target }}-${{ hashFiles('binutils-patches/*.patch') }}

      - name: Prepare sources (download NDK, apply patches)
        run: |
          chmod +x build.sh
          echo "=== Preparing sources ==="
          ./build.sh --target=${{ matrix.target }} prepare
          
          echo "=== Verifying source preparation ==="
          echo "--- GCC source ---"
          if [ -d "gcc-${{ env.GCC_VERSION }}" ]; then
            echo "  ✓ GCC ${{ env.GCC_VERSION }} source directory exists"
            ls gcc-${{ env.GCC_VERSION }}/*.c 2>/dev/null | head -3 || true
          else
            echo "  ✗ GCC source directory not found!"
            ls -la
            exit 1
          fi
          
          echo "--- Binutils source ---"
          if [ -d "binutils-${{ env.BINUTILS_VERSION }}" ]; then
            echo "  ✓ Binutils ${{ env.BINUTILS_VERSION }} source directory exists"
          else
            echo "  ✗ Binutils source directory not found!"
            exit 1
          fi
          
          echo "--- Sysroot ---"
          if [ -d "ndk/sysroot" ]; then
            echo "  ✓ NDK sysroot exists"
            echo "  Files: $(find ndk/sysroot -type f | wc -l)"
          else
            echo "  ✗ NDK sysroot not found!"
            exit 1
          fi
          
          echo "--- Disk space after prepare ---"
          df -h .

      - name: Build binutils
        if: steps.cache-binutils.outputs.cache-hit != 'true'
        run: |
          echo "=== Building Binutils ==="
          ./build.sh --target=${{ matrix.target }} binutils 2>&1 | tee build-binutils.log || {
            echo "=== BINUTILS BUILD FAILED ==="
            tail -100 build-binutils.log
            exit 1
          }

      - name: Configure GCC
        run: |
          echo "=== Configuring GCC ==="
          ./build.sh --target=${{ matrix.target }} configure 2>&1 | tee configure-gcc.log || {
            echo "=== GCC CONFIGURE FAILED ==="
            tail -100 configure-gcc.log
            echo "=== Checking for specific errors ==="
            grep -i "error\|cannot\|not found" configure-gcc.log | tail -30 || true
            exit 1
          }

      - name: Build GCC
        run: |
          echo "=== Building GCC ==="
          echo "Using $(nproc) parallel jobs"
          ./build.sh --target=${{ matrix.target }} --jobs=$(nproc) build 2>&1 | tee build-gcc.log || {
            echo "=== GCC BUILD FAILED ==="
            echo "--- Last 200 lines ---"
            tail -200 build-gcc.log
            echo "--- Error summary ---"
            grep -n -i "error\[:\]\|fatal\|failed" build-gcc.log | tail -30 || true
            exit 1
          }

      - name: Install GCC
        run: |
          echo "=== Installing GCC ==="
          ./build.sh --target=${{ matrix.target }} install 2>&1 | tee install-gcc.log || {
            echo "=== GCC INSTALL FAILED ==="
            tail -100 install-gcc.log
            exit 1
          }
          
          echo "--- Installation summary ---"
          echo "Installed files: $(find install -type f | wc -l)"
          echo "Total size: $(du -sh install | cut -f1)"

      - name: Verify toolchain
        id: verify
        run: |
          echo "=== Toolchain verification ==="
          export PATH="${PWD}/install/bin:${PATH}"
          
          # Check compiler version
          echo "--- GCC version ---"
          ${{ matrix.target }}-gcc --version
          
          echo "--- G++ version ---"
          ${{ matrix.target }}-g++ --version
          
          # Check binutils
          echo "--- Binutils ---"
          ${{ matrix.target }}-ld --version
          ${{ matrix.target }}-as --version
          
          # Test simple compilation
          echo "--- Test C compilation ---"
          echo 'int main() { return 0; }' > test.c
          ${{ matrix.target }}-gcc -c test.c -o test.o
          file test.o
          
          echo "--- Test C++ compilation ---"
          echo 'int main() { return 0; }' > test.cpp
          ${{ matrix.target }}-g++ -c test.cpp -o test_cpp.o
          file test_cpp.o
          
          echo "=== Verification completed ==="
          
          # Set output for dependent jobs
          if [[ "${{ matrix.target }}" == "x86_64-linux-ohos" ]]; then
            echo "x86_64-success=true" >> $GITHUB_OUTPUT
          elif [[ "${{ matrix.target }}" == "aarch64-linux-ohos" ]]; then
            echo "aarch64-success=true" >> $GITHUB_OUTPUT
          fi

      - name: Package cross-compiler toolchain
        run: |
          PACKAGE_NAME="gcc-${{ env.GCC_VERSION }}-cross-${{ matrix.target }}"
          mkdir -p artifacts
          tar -cJf "artifacts/${PACKAGE_NAME}.tar.xz" -C install .
          
          # Generate checksums
          cd artifacts
          sha256sum "${PACKAGE_NAME}.tar.xz" > "${PACKAGE_NAME}.tar.xz.sha256"

      - name: Upload cross-compiler artifact
        uses: actions/upload-artifact@v4
        with:
          name: gcc-cross-${{ matrix.target }}
          path: artifacts/
          retention-days: 30

      - name: Upload stage 1 install for Canadian Cross
        uses: actions/upload-artifact@v4
        with:
          name: stage1-${{ matrix.target }}
          path: install/
          retention-days: 1

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-stage1-${{ matrix.target }}
          path: |
            *.log
            build-ohos/config.log
            build-binutils/config.log
          retention-days: 7

  # Stage 2: Build native OHOS compiler (Canadian Cross)
  build-native:
    name: Stage 2 - Native OHOS Compiler ${{ matrix.target }}
    needs: build-cross
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    # Build native compiler unless explicitly disabled via workflow_dispatch
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.build_native != 'false' }}
    
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-linux-ohos
          - aarch64-linux-ohos
        include:
          - target: x86_64-linux-ohos
            arch: x86_64
          - target: aarch64-linux-ohos
            arch: aarch64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h
          
          # Remove unnecessary large packages
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /opt/hostedtoolcache/go
          
          echo "=== Disk space after cleanup ==="
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc g++ \
            make \
            flex bison \
            texinfo \
            libgmp-dev \
            libmpfr-dev \
            libmpc-dev \
            libisl-dev \
            zlib1g-dev \
            libzstd-dev \
            wget curl \
            tar xz-utils \
            file \
            python3 \
            autoconf automake libtool \
            pkg-config

      - name: Display Stage 2 build environment info
        run: |
          echo "=== Stage 2 Build Environment ==="
          echo "--- System info ---"
          uname -a
          
          echo "--- Compiler versions ---"
          gcc --version | head -1
          g++ --version | head -1
          
          echo "--- Available build compilers ---"
          echo "Checking x86_64-linux-gnu-gcc:"
          which x86_64-linux-gnu-gcc 2>/dev/null && x86_64-linux-gnu-gcc --version | head -1 || echo "  Not found"
          echo "Checking gcc:"
          which gcc && gcc --version | head -1
          
          echo "--- All available compilers ---"
          ls -la /usr/bin/*gcc* 2>/dev/null || true
          
          echo "--- Memory & Disk ---"
          free -h
          df -h

      - name: Download stage 1 cross-compiler
        uses: actions/download-artifact@v4
        with:
          name: stage1-${{ matrix.target }}
          path: install/

      - name: Verify stage 1 artifact extraction
        run: |
          echo "=== Verifying Stage 1 Artifact ==="
          
          echo "--- Directory structure ---"
          ls -la install/
          ls -la install/bin/ | head -20
          
          echo "--- File count ---"
          echo "Total files: $(find install -type f | wc -l)"
          echo "Binaries: $(find install/bin -type f | wc -l)"
          
          echo "--- Critical files check ---"
          critical_files=(
            "install/bin/${{ matrix.target }}-gcc"
            "install/bin/${{ matrix.target }}-g++"
            "install/bin/${{ matrix.target }}-ld"
            "install/bin/${{ matrix.target }}-as"
            "install/bin/${{ matrix.target }}-ar"
          )
          
          all_found=true
          for f in "${critical_files[@]}"; do
            if [ -f "$f" ]; then
              echo "  ✓ Found: $f ($(stat -c%s "$f") bytes)"
            else
              echo "  ✗ MISSING: $f"
              all_found=false
            fi
          done
          
          if [ "$all_found" != "true" ]; then
            echo "ERROR: Critical files missing from stage 1 artifact!"
            exit 1
          fi
          
          echo "--- libexec check ---"
          ls -la install/libexec/gcc/${{ matrix.target }}/ 2>/dev/null || echo "libexec directory structure may differ"

      - name: Make stage 1 tools executable
        run: |
          echo "=== Making Stage 1 Tools Executable ==="
          chmod +x install/bin/*
          chmod +x install/libexec/gcc/${{ matrix.target }}/*/* || true
          
          # Verify permissions
          echo "--- Verifying executable permissions ---"
          ls -la install/bin/${{ matrix.target }}-gcc
          
          # Add stage 1 to PATH and verify
          export PATH="${PWD}/install/bin:${PATH}"
          
          echo "--- Stage 1 GCC verification ---"
          echo "GCC location: $(which ${{ matrix.target }}-gcc)"
          ${{ matrix.target }}-gcc --version
          
          echo "--- Testing stage 1 compiler ---"
          echo 'int main() { return 0; }' > /tmp/test.c
          ${{ matrix.target }}-gcc -c /tmp/test.c -o /tmp/test.o && echo "  ✓ Stage 1 compiler works" || echo "  ✗ Stage 1 compiler failed"
          file /tmp/test.o

      - name: Build Canadian Cross (Stage 2)
        run: |
          set -o pipefail  # Ensure pipeline returns the exit code of the failed command
          
          echo "=== Building native OHOS compiler (Canadian Cross) ==="
          echo "Build configuration:"
          echo "  CBUILD: x86_64-linux-gnu"
          echo "  CHOST: ${{ matrix.target }}"
          echo "  CTARGET: ${{ matrix.target }}"
          echo "  Stage 1: ./install"
          echo "  Prefix: ./install-stage2"
          echo "  Jobs: $(nproc)"
          echo ""
          
          # Ensure clean build directory
          rm -rf build-ohos build-binutils
          
          # Run build with verbose output on failure
          if ! ./build.sh \
            --build=x86_64-linux-gnu \
            --host=${{ matrix.target }} \
            --target=${{ matrix.target }} \
            --stage1=./install \
            --prefix=./install-stage2 \
            --jobs=$(nproc) \
            all 2>&1 | tee build-stage2.log; then
              echo "=== BUILD FAILED - Last 200 lines of log ==="
              tail -200 build-stage2.log
              echo "=== Checking for configure errors ==="
              grep -n -i "error\|failed\|cannot\|not found" build-stage2.log | tail -50 || true
              echo "=== Checking CC_FOR_BUILD usage ==="
              grep -n "CC_FOR_BUILD\|checking build system compiler" build-stage2.log | tail -20 || true
              exit 1
          fi

      - name: Verify native compiler binaries
        run: |
          echo "=== Verifying native OHOS compiler ==="
          
          # Check that install directory exists and has content
          if [ ! -d "./install-stage2/bin" ]; then
            echo "ERROR: install-stage2/bin directory not found!"
            echo "Directory listing:"
            ls -la ./install-stage2/ 2>/dev/null || echo "install-stage2 does not exist"
            exit 1
          fi
          
          # Check critical binaries exist
          echo "--- Critical binary check ---"
          critical_bins=("gcc" "g++" "cpp")
          for bin in "${critical_bins[@]}"; do
            if [ -f "./install-stage2/bin/$bin" ]; then
              echo "  ✓ $bin: $(stat -c%s ./install-stage2/bin/$bin) bytes"
            else
              echo "  ✗ MISSING: $bin"
            fi
          done
          
          # Check that binaries are OHOS format
          echo "--- Binary format check ---"
          file ./install-stage2/bin/gcc
          file ./install-stage2/bin/g++
          
          # Verify it's an ELF for the right architecture
          echo "--- Architecture verification ---"
          readelf -h ./install-stage2/bin/gcc | grep -E 'Class|Machine|OS/ABI' || true
          
          # Verify interpreter is musl
          echo "--- Interpreter check ---"
          readelf -p .interp ./install-stage2/bin/gcc || true
          
          # Check dynamic dependencies
          echo "--- Dynamic dependencies ---"
          readelf -d ./install-stage2/bin/gcc | grep NEEDED || true
          
          # List installed files
          echo "--- Installed binaries ---"
          ls -la ./install-stage2/bin/
          
          # Count total installed files
          echo "--- Installation statistics ---"
          echo "Total files: $(find ./install-stage2 -type f | wc -l)"
          echo "Total size: $(du -sh ./install-stage2 | cut -f1)"
          
          echo "=== Verification completed ==="

      - name: Package native OHOS compiler
        run: |
          PACKAGE_NAME="gcc-${{ env.GCC_VERSION }}-native-${{ matrix.target }}"
          mkdir -p artifacts
          
          # Create tarball
          tar -cJf "artifacts/${PACKAGE_NAME}.tar.xz" -C install-stage2 .
          
          # Generate checksums
          cd artifacts
          sha256sum "${PACKAGE_NAME}.tar.xz" > "${PACKAGE_NAME}.tar.xz.sha256"
          
          # Create info file
          cat > "${PACKAGE_NAME}.info" << EOF
          Package: GCC Native Compiler for OpenHarmony
          GCC Version: ${{ env.GCC_VERSION }}
          Binutils Version: ${{ env.BINUTILS_VERSION }}
          Target: ${{ matrix.target }}
          Build Type: Canadian Cross (Stage 2)
          Build Date: $(date -u +%Y-%m-%d)
          Description: Native GCC compiler that runs on OHOS and compiles for OHOS
          EOF

      - name: Upload native compiler artifact
        uses: actions/upload-artifact@v4
        with:
          name: gcc-native-${{ matrix.target }}
          path: artifacts/
          retention-days: 30

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-stage2-${{ matrix.target }}
          path: |
            *.log
            build-ohos/config.log
            build-ohos/gcc/config.log
            build-ohos/gmp/config.log
            build-binutils/config.log
          retention-days: 7

  # Quick syntax and patch validation (runs faster than full build)
  validate:
    name: Validate patches
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate patch files
        run: |
          echo "=== Validating patch file syntax ==="
          
          for patch in gcc-patches/*.patch binutils-patches/*.patch sysroot-patches/*.patch; do
            if [ -f "$patch" ] && [ -s "$patch" ]; then
              echo "Checking: $patch"
              # Find first non-empty, non-comment line and check if it's valid diff format
              first_diff_line=$(grep -m1 -E '^(diff|From|---|\+\+\+|@@)' "$patch" || true)
              if [ -n "$first_diff_line" ]; then
                echo "  ✓ Valid patch format"
              else
                echo "  ✗ Invalid patch format - no diff headers found"
                exit 1
              fi
            fi
          done
          
          echo "=== All patches validated ==="

      - name: Check build script syntax
        run: |
          bash -n build.sh
          echo "✓ build.sh syntax OK"

  # Create release when tagged
  release:
    name: Create Release
    needs: [build-cross, build-native]
    runs-on: ubuntu-22.04
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: gcc-*
          merge-multiple: true

      - name: List release files
        run: |
          echo "=== Release files ==="
          ls -la artifacts/
          echo "=== Checksums ==="
          cat artifacts/*.sha256 || true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/*.tar.xz
            artifacts/*.sha256
            artifacts/*.info
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') }}
          generate_release_notes: true
          body: |
            ## GCC ${{ env.GCC_VERSION }} for OpenHarmony
            
            This release includes:
            - **Cross-compilers**: Run on Linux, compile for OHOS
            - **Native compilers**: Run on OHOS, compile for OHOS (Canadian Cross build)
            
            ### Packages
            
            | Package | Description |
            |---------|-------------|
            | `gcc-*-cross-*.tar.xz` | Cross-compiler (Linux host) |
            | `gcc-*-native-*.tar.xz` | Native compiler (OHOS host) |
            
            ### Supported Targets
            - `x86_64-linux-ohos` (x86_64)
            - `aarch64-linux-ohos` (ARM64)
            
            ### Installation
            
            ```bash
            # Cross-compiler (on Linux)
            tar -xJf gcc-*-cross-x86_64-linux-ohos.tar.xz -C /opt/ohos-gcc
            export PATH=/opt/ohos-gcc/bin:$PATH
            
            # Native compiler (on OHOS device)
            tar -xJf gcc-*-native-x86_64-linux-ohos.tar.xz -C /opt/gcc
            export PATH=/opt/gcc/bin:$PATH
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
